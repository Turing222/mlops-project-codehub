{"timestamp": "2026-01-12T02:12:43.057362", "level": "ERROR", "message": "计算发生了错误", "logger": "app.main", "module": "main", "func_name": "<module>", "line_no": 36, "exception": "Traceback (most recent call last):\n  File \"/home/tongying/workspace/mlops-project/app/main.py\", line 33, in <module>\n    1 / 0\n    ~~^~~\nZeroDivisionError: division by zero"}
{"timestamp": "2026-01-12T02:17:51.483679", "level": "ERROR", "message": "全局异常捕获: POST http://127.0.0.1:8000/api/v1/users/csv_upload - 服务器内部错误", "logger": "app.core.exceptions", "module": "exceptions", "func_name": "global_exception_handler", "line_no": 42, "exception": "Traceback (most recent call last):\n  File \"/home/tongying/workspace/mlops-project/app/api/v1/endpoint/user.py\", line 108, in csv_balk_insert_users\n    await process_user_import(session, cleaned_data)\n  File \"/home/tongying/workspace/mlops-project/app/services/user_service.py\", line 37, in process_user_import\n    batches = [user_maps[i:i + BATCH_SIZE] for i in range(0, len(user_maps), BATCH_SIZE)]\n                                                             ^^^^^^^^^^^^^^\nTypeError: object of type 'AsyncSession' has no len()\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/fastapi/routing.py\", line 118, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/fastapi/routing.py\", line 104, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/fastapi/routing.py\", line 428, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/fastapi/routing.py\", line 314, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/tongying/workspace/mlops-project/app/api/v1/endpoint/user.py\", line 120, in csv_balk_insert_users\n    raise ServiceError(\"服务器内部错误\") from e\napp.core.exceptions.ServiceError: 服务器内部错误"}
{"timestamp": "2026-01-12T02:23:02.913439", "level": "ERROR", "message": "全局异常捕获: POST http://127.0.0.1:8000/api/v1/users/csv_upload - 服务器内部错误", "logger": "app.core.exceptions", "module": "exceptions", "func_name": "global_exception_handler", "line_no": 42, "exception": "Traceback (most recent call last):\n  File \"/home/tongying/workspace/mlops-project/app/services/user_service.py\", line 53, in process_user_import\n    async with session.begin():\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py\", line 121, in __aenter__\n    return await self.start(is_ctxmanager=True)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py\", line 1876, in start\n    await greenlet_spawn(\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 190, in greenlet_spawn\n    result = context.switch(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py\", line 1941, in begin\n    raise sa_exc.InvalidRequestError(\nsqlalchemy.exc.InvalidRequestError: A transaction is already begun on this Session.\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/home/tongying/workspace/mlops-project/app/api/v1/endpoint/user.py\", line 108, in csv_balk_insert_users\n    await process_user_import(cleaned_data,session)\n  File \"/home/tongying/workspace/mlops-project/app/services/user_service.py\", line 86, in process_user_import\n    raise DatabaseOperationError(\"数据库操作执行失败\", original_error=e) from e\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nTypeError: AppError.__init__() got an unexpected keyword argument 'original_error'\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/fastapi/routing.py\", line 118, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/fastapi/routing.py\", line 104, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/fastapi/routing.py\", line 428, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/fastapi/routing.py\", line 314, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/tongying/workspace/mlops-project/app/api/v1/endpoint/user.py\", line 120, in csv_balk_insert_users\n    raise ServiceError(\"服务器内部错误\") from e\napp.core.exceptions.ServiceError: 服务器内部错误"}
{"timestamp": "2026-01-12T02:24:10.314036", "level": "ERROR", "message": "全局异常捕获: POST http://127.0.0.1:8000/api/v1/users/csv_upload - 数据库操作执行失败", "logger": "app.core.exceptions", "module": "exceptions", "func_name": "global_exception_handler", "line_no": 42, "exception": "Traceback (most recent call last):\n  File \"/home/tongying/workspace/mlops-project/app/services/user_service.py\", line 53, in process_user_import\n    async with session.begin():\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py\", line 121, in __aenter__\n    return await self.start(is_ctxmanager=True)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py\", line 1876, in start\n    await greenlet_spawn(\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 190, in greenlet_spawn\n    result = context.switch(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py\", line 1941, in begin\n    raise sa_exc.InvalidRequestError(\nsqlalchemy.exc.InvalidRequestError: A transaction is already begun on this Session.\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/fastapi/routing.py\", line 118, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/fastapi/routing.py\", line 104, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/fastapi/routing.py\", line 428, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/fastapi/routing.py\", line 314, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/tongying/workspace/mlops-project/app/api/v1/endpoint/user.py\", line 108, in csv_balk_insert_users\n    await process_user_import(cleaned_data,session)\n  File \"/home/tongying/workspace/mlops-project/app/services/user_service.py\", line 86, in process_user_import\n    raise DatabaseOperationError(\"数据库操作执行失败\") from e\napp.core.exceptions.DatabaseOperationError: 数据库操作执行失败"}
{"timestamp": "2026-01-12T02:48:24.526359", "level": "ERROR", "message": "全局异常捕获: POST http://127.0.0.1:8000/api/v1/users/csv_upload - Internal server error during import", "logger": "app.core.exceptions", "module": "exceptions", "func_name": "global_exception_handler", "line_no": 42, "exception": "Traceback (most recent call last):\n  File \"/home/tongying/workspace/mlops-project/app/services/user_service.py\", line 55, in process_user_import\n    raise ValidationError(f\"以下用户名已被占用，无法注册: {existing_names}\")\napp.core.exceptions.ValidationError: 以下用户名已被占用，无法注册: {'test1', 'test2'}\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/fastapi/routing.py\", line 118, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/fastapi/routing.py\", line 104, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/fastapi/routing.py\", line 428, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/tongying/workspace/mlops-project/.venv/lib/python3.11/site-packages/fastapi/routing.py\", line 314, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/tongying/workspace/mlops-project/app/api/v1/endpoint/user.py\", line 108, in csv_balk_insert_users\n    await process_user_import(cleaned_data,session)\n  File \"/home/tongying/workspace/mlops-project/app/services/user_service.py\", line 95, in process_user_import\n    raise ServiceError(\"Internal server error during import\") from e\napp.core.exceptions.ServiceError: Internal server error during import"}
